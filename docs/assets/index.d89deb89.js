var f=Object.defineProperty;var g=Object.getOwnPropertySymbols;var m=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable;var u=(l,t,s)=>t in l?f(l,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[t]=s,p=(l,t)=>{for(var s in t||(t={}))m.call(t,s)&&u(l,s,t[s]);if(g)for(var s of g(t))v.call(t,s)&&u(l,s,t[s]);return l};import{s as w,a as y,t as b}from"./vendor.038ccdfb.js";const E=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function s(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerpolicy&&(i.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?i.credentials="include":e.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(e){if(e.ep)return;e.ep=!0;const i=s(e);fetch(e.href,i)}};E();const k=document.querySelector.bind(document),h=document.createElement("style");h.dataset.flowx=!0;k("head").appendChild(h);const x=l=>{h.sheet.insertRule(l)};class C{constructor(t={}){const s={canvasElement:t.canvasElement,onRender:t.onRender,handleClass:t.handleClass||".flowx-drag",nodeWidth:t.nodeWidth||320,nodeHeight:t.nodeHeight||80,marginX:t.marginX||50,marginY:t.marginY||20};this.onRender=s.onRender,this.canvasElement=s.canvasElement,this.config=s,this.blocks=[],this.canvasElement.style.position="relative",this.canvasElement.style.cursor="grab",x(`
    .flowx-block {
      width: ${s.nodeWidth}px;
      height: ${s.nodeHeight}px;
    }
    `),this.svg=w(this.canvasElement).append("svg").attr("style","position: absolute; left: 0; top: 0;").attr("width",this.canvasElement.offsetWidth).attr("height",this.canvasElement.offsetHeight).append("g"),this.dragEl=null,this.dragData=null,this.draggingBlocks=null,this.dragAnchor=null,this.canvasDragStart=null,this.dragX=0,this.dragY=0,this.absx=this.canvasElement.getBoundingClientRect().left,this.absy=this.canvasElement.getBoundingClientRect().top,this.isCopy=!1,document.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))}onMouseDown(t){this.beginDragNewNode(t),this.beginDragOldNode(t),this.beginCanvasMove(t)}onMouseMove(t){this.onCanvasMove(t),this.onNodeMove(t)}onMouseUp(){this.endDragNewNode(),this.endDragOldNode(),this.endCanvasMove()}beginCanvasMove(t){t.target.nodeName==="svg"&&(this.canvasDragStart={x:t.clientX,y:t.clientY})}onCanvasMove(t){this.canvasDragStart==null||this.d3Tree==null||(this.d3Tree.each(s=>{s.data.top=s.data.top+t.clientY-this.canvasDragStart.y,s.data.left=s.data.left+t.clientX-this.canvasDragStart.x,s.data.el.style.top=s.data.top+"px",s.data.el.style.left=s.data.left+"px"}),this.canvasDragStart={x:t.clientX,y:t.clientY},this.drawLinks())}endCanvasMove(){this.canvasDragStart=null}beginDragOldNode(t){const s=t.target.closest(".flowx-block");if(s==null)return;this.dragX=t.clientX,this.dragY=t.clientY;const n=Number(s.dataset.flowxId),e=document.createElement("div");e.style.left=this.dragX+"px",e.style.top=this.dragY+"px",e.style.cssText=`
      position: absolute;
      z-index: 10;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
    `;const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.style.position="absolute",i.style.width=this.canvasElement.offsetWidth+"px",i.style.height=this.canvasElement.offsetHeight+"px",e.appendChild(i),this.draggingBlocks=this.getChildren(this.blocks,n).concat(this.blocks.find(a=>a.id===n)),this.draggingBlocks.forEach(a=>{e.appendChild(a.el.cloneNode(!0)),i.append(this.svg.select(`[data-flowx-source="${a.id}"]`).clone().node()),n!==a.id&&i.append(this.svg.select(`[data-flowx-target="${a.id}"]`).clone().node())}),this.dragAnchor=e.querySelector(`[data-flowx-id="${n}"]`),this.dragEl=e,this.canvasElement.appendChild(e)}beginDragNewNode(t){const s=t.target.closest(this.config.handleClass);if(s==null)return;const n=t.clientX,e=t.clientY,i=s.getBoundingClientRect().left,a=s.getBoundingClientRect().top,o=n-i,d=e-a,r=s.cloneNode(!0);r.style.left=o+"px",r.style.top=d+"px",r.classList.add("flowx-dragging"),document.body.appendChild(r),this.dragEl=r,this.dragData=this.getFlowxData(s),this.dragX=o,this.dragY=d}onNodeMove(t){if(!this.dragEl)return;this.dragEl.style.left=t.clientX-this.dragX+"px",this.dragEl.style.top=t.clientY-this.dragY+"px",this.blocks.forEach(n=>n.el.style.border="");const s=this.blocks.find(n=>this.dragAnchor&&this.draggingBlocks.find(e=>n.id===e.id)?!1:this.checkAttach(n.el,this.dragAnchor||this.dragEl));s&&(s.el.style.border="2px solid #217ce8")}async endDragOldNode(){if(!this.dragAnchor)return;const t=Number(this.dragAnchor.dataset.flowxId),s=this.blocks.find(e=>e.id===t),n=this.blocks.find(e=>this.draggingBlocks.find(i=>e.id===i.id)?!1:this.checkAttach(e.el,this.dragAnchor));if(n!=null){if(this.isCopy){const e=this.draggingBlocks.map(o=>p({},o)),i=e.find(o=>o.id===s.id);e.forEach((o,d)=>{const r=this.blocks.length+d;e.filter(c=>c.parent===o.id).forEach(c=>c.parent=r),o.id=r}),i.parent=n.id,(await Promise.all(e.map(o=>this.renderBlock(o.data,o.id)))).forEach((o,d)=>{e[d].el=o}),this.blocks.push(...e)}else s.parent=n.id;n.el.style.border="",this.layout()}this.dragAnchor=null,this.draggingBlocks=null,this.dragEl.parentNode.removeChild(this.dragEl),this.dragEl=null}async endDragNewNode(){if(!this.dragEl||this.dragAnchor)return;const t=this.dragEl.getBoundingClientRect().x,s=this.dragEl.getBoundingClientRect().y;let n=!1;const e={id:this.blocks.length,data:this.dragData,parent:"",el:null,left:null,top:null};if(this.blocks.length===0)e.left=t-this.absx,e.top=s-this.absy,n=!0;else{const i=this.blocks.find(a=>this.checkAttach(a.el,this.dragEl));i!=null&&(n=!0,e.parent=i.id,i.el.style.border="")}n&&(this.blocks.push(e),e.el=await this.renderBlock(e.data,e.id),this.layout()),this.dragEl.parentNode.removeChild(this.dragEl),this.dragEl=null}onKeyDown(t){t.keyCode===18&&this.dragAnchor&&(this.dragAnchor.classList.add("flowx-block--copy"),this.isCopy=!0)}onKeyUp(){this.isCopy=!1,this.dragAnchor&&this.dragAnchor.classList.remove("flowx-block--copy")}layout(){if(this.blocks.length===0)return;const s=y().id(a=>a.id).parentId(a=>a.parent)(this.blocks);this.d3Tree=b().nodeSize([this.config.nodeHeight+this.config.marginY,this.config.nodeWidth+this.config.marginX])(s);const n=this.blocks.find(a=>a.id===0),e=n.left,i=n.top;this.d3Tree.each(a=>{a.data.top=a.x+i,a.data.left=a.y+e,a.data.el.style.top=a.data.top+"px",a.data.el.style.left=a.data.left+"px"}),this.drawLinks()}drawLinks(){this.svg.selectAll("path").remove(),this.svg.selectAll("path.link").data(this.d3Tree.links()).enter().append("path").attr("class","flowx-link").attr("data-flowx-target",t=>t.target.data.id).attr("data-flowx-source",t=>t.source.data.id).attr("d",t=>"M"+(t.source.data.left+this.config.nodeWidth)+","+(t.source.data.top+this.config.nodeHeight/2)+"h25v"+(t.target.data.top-t.source.data.top)+"h25")}getChildren(t,s){const n=t.filter(e=>e.parent===s);return n.concat(n.map(e=>this.getChildren(t,e.id)).flat())}checkAttach(t,s){const n=t.getBoundingClientRect(),e=s.getBoundingClientRect();return!(e.right<n.left||e.left>n.right||e.bottom<n.top||e.top>n.bottom)}getFlowxData(t){const s={};return Object.keys(t.dataset).forEach(n=>{n.startsWith("flowx")&&(s[n.slice("flowx".length).toLowerCase()]=t.dataset[n])}),s}async clear(){this.blocks.forEach(t=>{t.el.parentNode.removeChild(t.el)}),this.blocks=[],this.svg.selectAll("path").remove()}async renderBlock(t,s){const n=document.createElement("div");n.classList.add("flowx-block"),n.dataset.flowxId=s;const e=document.createElement("div");return this.canvasElement.appendChild(n),n.appendChild(e),await this.onRender(t,e),n}}const D=document.querySelector.bind(document);new Vue({el:"#app",data(){return{drawer:!1}},mounted(){const l=this;window.flowx=new C({canvasElement:D("#canvas"),onRender:(t,s)=>new Promise((n,e)=>{new Vue({el:s,template:`
              <div
                style="height: 100%; width: 100%;"
                @dblclick="openDrawer"
              >
                <div>
                  <label for="cars">rule</label>
                  <select v-model="rule">
                    <option value="1">rule1</option>
                    <option value="2">rule2</option>
                    <option value="3">rule3</option>
                    <option value="4">rule4</option>
                  </select>
                </div>

                <div @mousedown.stop>
                  <label>
                    triggered
                    <input type="radio" :value="true" v-model="triggered">
                  </label>

                  &nbsp;&nbsp;&nbsp;

                  <label>
                    not triggered
                    <input type="radio" :value="false" v-model="triggered">
                  </label>
                </div>
              </div>
            `,data(){return{rule:t.id||"1",triggered:!0,drawer:!0}},methods:{onClick(){this.id++},openDrawer(){l.openDrawer()}},mounted(){n()}})})})},methods:{clear(){flowx.clear()},openDrawer(){this.drawer=!0}}});
